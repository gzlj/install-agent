- name: kubeadm 
  copy:
    dest: /opt/kubeadm-conf.yaml
    content: |
      apiVersion: kubeadm.k8s.io/v1beta1
      bootstrapTokens:
      - groups:
        - system:bootstrappers:kubeadm:default-node-token
        token: b99a00.a144ef80536d4344
        ttl: 0s
        usages:
        - signing
        - authentication
      kind: InitConfiguration
      ---
      apiVersion: kubeadm.k8s.io/v1beta1
      certificatesDir: /etc/kubernetes/pki
      clusterName: kubernetes
      controlPlaneEndpoint: "{{ control_plane_endpoint }}"
      apiServer:
        certSANs:
        - {{ master_ip }}
        timeoutForControlPlane: 4m0s
        extraArgs:
          insecure-bind-address : "0.0.0.0"
          insecure-port : "8080"
      kind: ClusterConfiguration
      kubernetesVersion: {{ kubernetes_version | default('v1.14.2') }}
      imageRepository: {{ lan_registry }}
      networking:
        podSubnet: {{ pod_subnet | default('10.244.0.0/16') }}
      ---
      apiVersion: kubelet.config.k8s.io/v1beta1
      readOnlyPort: 10255
      evictionHard:
        imagefs.available: 5%
        memory.available: 2Gi
        nodefs.available: 10%
        nodefs.inodesFree: 5%
      kind: KubeletConfiguration
      ---
      apiVersion: kubeproxy.config.k8s.io/v1alpha1
      kind: KubeProxyConfiguration
      mode: {{ kubeproxy_mode | default('iptables') }}
- name: bootstrap k8s 
  shell: | 
    kubeadm init --config /opt/kubeadm-conf.yaml
    mkdir -p $HOME/.kube
    sudo /bin/cp -f /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config
    kubectl taint nodes --all node-role.kubernetes.io/master-
    kubectl apply -f /opt/kube-flannel.yml
    kubectl apply -f /opt/prometheus/manifests
    kubectl apply -f /opt/prometheus/manifests
