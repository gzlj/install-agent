---
- hosts: test
  remote_user: root
  tasks:   
  - name: set up kubeadm-conf.yaml
    copy:
      dest: /opt/kubeadm-conf.yaml
      content: |
        apiVersion: kubeadm.k8s.io/v1beta1
        bootstrapTokens:
        - groups:
          - system:bootstrappers:kubeadm:default-node-token
          token: b99a00.a144ef80536d4344
          ttl: 0s
          usages:
          - signing
          - authentication
        kind: InitConfiguration
        ---
        apiVersion: kubeadm.k8s.io/v1beta1
        certificatesDir: /etc/kubernetes/pki
        clusterName: kubernetes
        controlPlaneEndpoint: "{{ control_plane_endpoint }}"
        apiServer:
          certSANs:
          - {{ master_ip }}
          timeoutForControlPlane: 4m0s
          extraArgs:
            insecure-bind-address : "0.0.0.0"
            insecure-port : "8080"
        kind: ClusterConfiguration
        kubernetesVersion: {{ kubernetes_version }}
        imageRepository: "{{ lan_registry }}"
        networking:
          podSubnet: {{ pod_subnet | default('10.244.0.0/16') }}
        ---
        apiVersion: kubelet.config.k8s.io/v1beta1
        readOnlyPort: 10255
        evictionHard:
          imagefs.available: 5%
          memory.available: 2Gi
          nodefs.available: 10%
          nodefs.inodesFree: 5%
        kind: KubeletConfiguration
        ---
        apiVersion: kubeproxy.config.k8s.io/v1alpha1
        kind: KubeProxyConfiguration
        mode: {{ kubeproxy_mode | default('iptables')}}
  - name: set up opt dir 
    file: name=/opt state=directory  
  - name: flannel yaml    
    copy:
        dest: /opt/kube-flannel.yml
        content: |
          ---
          apiVersion: extensions/v1beta1
          kind: PodSecurityPolicy
          metadata:
            name: psp.flannel.unprivileged
            annotations:
              seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default
              seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default
              apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
              apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
          spec:
            privileged: false
            volumes:
              - configMap
              - secret
              - emptyDir
              - hostPath
            allowedHostPaths:
              - pathPrefix: "/etc/cni/net.d"
              - pathPrefix: "/etc/kube-flannel"
              - pathPrefix: "/run/flannel"
            readOnlyRootFilesystem: false
            # Users and groups
            runAsUser:
              rule: RunAsAny
            supplementalGroups:
              rule: RunAsAny
            fsGroup:
              rule: RunAsAny
            # Privilege Escalation
            allowPrivilegeEscalation: false
            defaultAllowPrivilegeEscalation: false
            # Capabilities
            allowedCapabilities: ['NET_ADMIN']
            defaultAddCapabilities: []
            requiredDropCapabilities: []
            # Host namespaces
            hostPID: false
            hostIPC: false
            hostNetwork: true
            hostPorts:
            - min: 0
              max: 65535
            # SELinux
            seLinux:
              # SELinux is unsed in CaaSP
              rule: 'RunAsAny'
          ---
          kind: ClusterRole
          apiVersion: rbac.authorization.k8s.io/v1beta1
          metadata:
            name: flannel
          rules:
            - apiGroups: ['extensions']
              resources: ['podsecuritypolicies']
              verbs: ['use']
              resourceNames: ['psp.flannel.unprivileged']
            - apiGroups:
                - ""
              resources:
                - pods
              verbs:
                - get
            - apiGroups:
                - ""
              resources:
                - nodes
              verbs:
                - list
                - watch
            - apiGroups:
                - ""
              resources:
                - nodes/status
              verbs:
                - patch
          ---
          kind: ClusterRoleBinding
          apiVersion: rbac.authorization.k8s.io/v1beta1
          metadata:
            name: flannel
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: flannel
          subjects:
          - kind: ServiceAccount
            name: flannel
            namespace: kube-system
          ---
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: flannel
            namespace: kube-system
          ---
          kind: ConfigMap
          apiVersion: v1
          metadata:
            name: kube-flannel-cfg
            namespace: kube-system
            labels:
              tier: node
              app: flannel
          data:
            cni-conf.json: |
              {
                "name": "cbr0",
                "plugins": [
                  {
                    "type": "flannel",
                    "delegate": {
                      "hairpinMode": true,
                      "isDefaultGateway": true
                    }
                  },
                  {
                    "type": "portmap",
                    "capabilities": {
                      "portMappings": true
                    }
                  }
                ]
              }
            net-conf.json: |
              {
                "Network": "{{ pod_subnet | default('10.244.0.0/16') }}",
                "Backend": {
                  "Type": "vxlan"
                }
              }
          ---
          apiVersion: extensions/v1beta1
          kind: DaemonSet
          metadata:
            name: kube-flannel-ds-amd64
            namespace: kube-system
            labels:
              tier: node
              app: flannel
          spec:
            template:
              metadata:
                labels:
                  tier: node
                  app: flannel
              spec:
                hostNetwork: true
                nodeSelector:
                  beta.kubernetes.io/arch: amd64
                tolerations:
                - operator: Exists
                  effect: NoSchedule
                serviceAccountName: flannel
                initContainers:
                - name: install-cni
                  image: jmgao1983/flannel:v0.11.0-amd64 
                  command:
                  - cp
                  args:
                  - -f
                  - /etc/kube-flannel/cni-conf.json
                  - /etc/cni/net.d/10-flannel.conflist
                  volumeMounts:
                  - name: cni
                    mountPath: /etc/cni/net.d
                  - name: flannel-cfg
                    mountPath: /etc/kube-flannel/
                containers:
                - name: kube-flannel
                  image: jmgao1983/flannel:v0.11.0-amd64 
                  command:
                  - /opt/bin/flanneld
                  args:
                  - --ip-masq
                  - --kube-subnet-mgr
                  resources:
                    requests:
                      cpu: "100m"
                      memory: "50Mi"
                    limits:
                      cpu: "100m"
                      memory: "50Mi"
                  securityContext:
                    privileged: false
                    capabilities:
                       add: ["NET_ADMIN"]
                  env:
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  volumeMounts:
                  - name: run
                    mountPath: /run/flannel
                  - name: flannel-cfg
                    mountPath: /etc/kube-flannel/
                volumes:
                  - name: run
                    hostPath:
                      path: /run/flannel
                  - name: cni
                    hostPath:
                      path: /etc/cni/net.d
                  - name: flannel-cfg
                    configMap:
                      name: kube-flannel-cfg        
  - name: prometheus config
    shell: docker run --name bu --rm -d -v /opt/prometheus/manifests:/opt/prometheus/manifests gzlj2018/busybox:prometheus-v2.7-conf   
  - name: copy kubeadm binary
    copy:
      src: /usr/bin/kubeadm
      dest: /usr/bin/kubeadm   
  - name: install k8s component
    shell: | 
      kubeadm init --config /opt/kubeadm-conf.yaml
      mkdir -p $HOME/.kube
      sudo /bin/cp -f /etc/kubernetes/admin.conf $HOME/.kube/config
      sudo chown $(id -u):$(id -g) $HOME/.kube/config
      kubectl taint nodes --all node-role.kubernetes.io/master-
      kubectl apply -f /opt/kube-flannel.yml
      kubectl apply -f /opt/prometheus/manifests
      kubectl apply -f /opt/prometheus/manifests

    
  
